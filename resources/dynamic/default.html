<!DOCTYPE html>
<html lang="en">
    <head>
        <title>{%= CurrentADP.Var("window_title") %}</title>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Askia - software for surveys">
        <meta name="theme-color" content="#DF4335">
        <link rel="icon" href="{%:= CurrentADP.URLTo("static/favicon.png") %}">

        <!--- ASKIA HEAD HERE -->
        {%:= CurrentADP.Var("headHTML") %}
        <askia-head />
    </head>
    <body>
        <header id="nav" class="large">
            {%
            Dim qid = CurrentQuestion.id
            Dim attrDisabled = On(Interview.IsFirstPage, "disabled=\"disabled\"", "")
            Dim classDisabled = On(Interview.IsFirstPage, "disabled", "")
            Dim adpSurveyName = CurrentADP.Var("survey_name")
            Dim adpSurveyLogoSrc = CurrentADP.Var("survey_logo_src")
            Dim adpSurveyLogoAlt = CurrentADP.Var("survey_logo_alt")
            Dim errors_caption = CurrentADP.Var("errors_caption")
            If (adpSurveyLogoSrc <> "") Then  %}
            <div class="logo-survey"><img src="{%= adpSurveyLogoSrc %}" alt="{%= adpSurveyLogoAlt %}" /></div>
            {% End If %}
            {% If (adpSurveyLogoSrc = "") and (adpSurveyName = "") Then  %}
            <div class="logo-survey"><img src="{%:= CurrentADP.URLTo("static/logo-askia-rvb.png") %}" alt="Askia logo" /></div>
            {% End If %}
            {% If (adpSurveyLogoSrc = "") and (adpSurveyName <> "") Then  %}
            <h2>{%= adpSurveyName %}</h2>
            {% End If %}
            <div class="progressWrapper">
                <div class="progress">
                    <div class="progress-bar"></div>
                    {% If CurrentADP.Var("display_progress_value") = "yes" Then %}
                    <div class="progress-value">{%= Interview.Progress.ToInt() %}%</div>
                    {% EndIf %}
                </div>
            </div>
        </header>
        <div class="ribbon"></div>
        <div class="main">
            <!--- ASKIA FORM BEGINS HERE -->
            <askia-form>
                <div class="askiaquestions">
                    {% If CurrentQuestions.Errors.Count Then %}
                    <div class="askia-errors-summary">
                        <!--insert errors here -->
                    </div>
                    {% End If %}
                    <!--- ASKIA QUESTIONS HERE -->
                    <askia-questions />
                    <div class="navigation">
                        {% If CurrentADP.Var("display_previous") = "yes" Then %}
                        <input type="submit" name="Previous" class="btn secondary keyframe {%:= classDisabled %}" value="{%= CurrentADP.Var("previous_caption") %}" {%:= attrDisabled %} />
                        {% End If %}
                        <input type="submit" name="Next" class="btn primary keyframe" value="{%= CurrentADP.Var("next_caption") %}" />
                    </div>
                </div>

              {%
                Dim closeType = CurrentADP.Var("modal_close_type")
                Dim duration = CurrentADP.Var("duration")
                Dim numOfAttempts = CurrentADP.Var("num_of_attempts")
                Dim showModal = CurrentADP.Var("show_modal")
                Dim modalContent = CurrentADP.Var("modal_content")
              %}

              <div id="modalOnSubmit" class="modal">
                <div class="modal-content">
                    <div class="modal-loading" align="middle">
                          <div class="loader-main">{%:= modalContent %}</div>
                          <div class="close-div"><input type="submit" name="Close" id="closeButton" class="close_button" value="Close"></div>
                    </div>
                </div>
              </div>

            </askia-form>
            <!--- ASKIA FORM ENDS HERE -->
        </div>
        <footer>
            <div class="footerLeft">{%:= CurrentADP.Var("footer_left") %}</div>
            <div class="footerRight">{%:= CurrentADP.Var("footer_right") %}</div>
        </footer>
        <!--- ASKIA FOOT HERE -->
        {%:= CurrentADP.Var("footHTML") %}
        <askia-foot />
        <script>

        function modalShow(duration,type){
          var modal = document.getElementById('modalOnSubmit');
          modal.style.display = "block";
          // AutoSubmit(10,"s");
          if(type == 2){
            var cl_button = document.getElementById("closeButton");
            cl_button.style.display = "none";

            setTimeout(function(){
              cl_button.click();
              modal.style.display = "none";
            }, duration * 1000);
          }

        }


		var errorUL = "";

		{% If (errors_caption <> "") Then  %}
        	errorUL = "<p>{%:= errors_caption %}</p>";
        {% End If %}

        errorUL = errorUL + "<ul>";

    	{% Dim xerrorIndex = 1
			For xerrorIndex = 1 To CurrentQuestions.Errors.Count
    dim origError = CurrentQuestions.Errors[xerrorIndex].Message.ToString().Replace(crlf," ")
		%}
        var errorMsg = "{%= origError %}";
        var strippedMsg = errorMsg.replace(/&lt;br\/&gt;/g, ' ');
        strippedMsg = strippedMsg.replace(/&lt;[^&gt;]+&gt;/g, '');
        strippedMsg = strippedMsg.replace(/<[^>]+>/g, '');
		errorUL = errorUL + "<li>" + strippedMsg + "</li>";
		{% Next %}

    var emElems = document.querySelectorAll('[data-email-err]');

    for (var i = 0; i < emElems.length; i++) {
      var test = checkEmailRegex(emElems[i]);
      errorUL = (!test) ? (errorUL + "<li>"+ emElems[i].getAttribute('data-email-err') +"</li>") : errorUL;
    }

		errorUL = errorUL+ "</ul>";

    if (document.getElementsByClassName('askia-errors-summary')[0])	document.getElementsByClassName('askia-errors-summary')[0].innerHTML=errorUL;

    // check RegExp on email
    function checkEmailRegex(elem){
      var emailRegExp = /^[a-zA-Z0-9.!#$%&'*+/=?^_`{|}~-]+@[a-zA-Z0-9-]+(?:\.[a-zA-Z0-9-]+)*$/;
      var test = elem.value.length === 0 || emailRegExp.test(elem.value);
      return test;
    }

		</script>
        <script>




            document.addEventListener("DOMContentLoaded", function(){
                var fixed = false,
                    nav = document.getElementById('nav'),
                    position = nav.offsetTop;

                /**
           * Add class in DOMElement
           *
           * @param {HTMLElement} obj HTMLElement where the class should be added
           * @param {String} clsName Name of the class to add
           */
                function addClass(obj, clsName) {
                    if (obj.classList)
                        obj.classList.add(clsName);
                    else
                        obj.className += ' ' + clsName;
                }

                /**
           * Remove class in DOMElement
           *
           * @param {HTMLElement} obj HTMLElement where the class should be removed
           * @param {String} clsName Name of the class to remove
           */
                function removeClass(obj, clsName) {
                    if (obj.classList)
                        obj.classList.remove(clsName);
                    else
                        obj.className = obj.className.replace(new RegExp('(^|\\b)' + clsName.split(' ').join('|') + '(\\b|$)', 'gi'), ' ');
                }

                function Matter() {
                    if ('{%= CurrentADP.Var("sticky_header") %}' !== 'yes') return;
                        var scrollY = window.scrollY || window.pageYOffset;
                        if (scrollY > position && !fixed && !nav.className.match(new RegExp('(\\s|^)'+'fixed'+'(\\s|$)'))) {
                        fixed = true;
                        addClass(nav,'fixed')
                    } else if (scrollY <= position && fixed && !!nav.className.match(new RegExp('(\\s|^)'+'fixed'+'(\\s|$)'))) {
                        fixed = false;
                        removeClass(nav,'fixed')
                    }
                }

                window.onscroll = Matter;
                document.addEventListener("click", function(event){
                    var el = event.target || event.srcElement;
                    {% If showModal = "yes" Then %}
                      {% If (numOfAttempts = 0 OR (numOfAttempts = 1 AND qid = 1)) Then %}
                        if(el.type == "submit" && el.name == "Next"){
                          event.stopPropagation();
                          event.preventDefault();
                          modalShow('{%= duration %}','{%= closeType %}');
                        }
                      {% EndIf %}
                    {% EndIf %}

                    if ((el.nodeName === "TD" || el.nodeName === "LI" ) && el.className.indexOf("askia-response") >= 0 && el.className.indexOf("askia-response-label") < 0) {
						document.getElementById(el.lastElementChild.attributes.for.value).click();
                    }
                },false);
            });
        </script>
    </body>
</html>
